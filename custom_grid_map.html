<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nevos Custom Grid Map</title>
  <!-- Leaflet CSS (online version; swap for local copy if running offline) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- Minimal styles for layout and controls -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }
    #app {
      display: grid;
      grid-template-columns: 320px 1fr;
      height: 100%;
    }
    aside {
      border-right: 1px solid #ddd;
      padding: 12px;
      overflow: auto;
    }
    aside h1 {
      font-size: 16px;
      margin: 0 0 8px;
    }
    aside .controls {
      display: grid;
      gap: 8px;
      margin-bottom: 12px;
    }
    aside input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    aside button,
    .btn {
      padding: 8px 10px;
      border: 1px solid #bbb;
      background: #f6f6f6;
      border-radius: 6px;
      cursor: pointer;
    }
    aside .row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    aside .small {
      font-size: 12px;
      color: #555;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
      font-size: 11px;
    }
    .favorite {
      color: #cc8a00;
    }
    .list {
      display: grid;
      gap: 8px;
    }
    .card {
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 8px;
      background: #fff;
    }
    .card h3 {
      font-size: 14px;
      margin: 0 0 6px;
    }
    .card .meta {
      font-size: 12px;
      color: #666;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card .actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    /* Popup form styles */
    .form-grid {
      display: grid;
      gap: 6px;
      min-width: 220px;
    }
    .form-grid label {
      font-size: 12px;
      color: #333;
    }
    .form-grid input[type="text"],
    .form-grid textarea,
    .form-grid select {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
    }
    .form-grid textarea {
      min-height: 60px;
      resize: vertical;
    }
    .stars {
      font-size: 16px;
      letter-spacing: 1px;
    }
    /* Grid overlay labels */
    .grid-label {
      position: absolute;
      pointer-events: none;
      font-size: 12px;
      color: #333;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 4px;
      border-radius: 4px;
    }
    .leaflet-overlay-pane .grid-line {
      stroke: rgba(0, 0, 0, 0.25);
      stroke-width: 1;
    }
    .footer {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <aside>
      <h1>Nevos Custom Grid Map</h1>
      <div class="controls">
        <input id="search" type="text" placeholder="Search name, notes, tag, cell…" />
        <div class="row">
          <label><input type="checkbox" id="onlyFavs" /> Favorites only</label>
          <label><input type="checkbox" id="showGrid" checked /> Show grid</label>
        </div>
        <div class="row">
          <button id="exportBtn">Export JSON</button>
          <label class="btn" for="importFile">Import JSON</label>
          <input id="importFile" type="file" accept="application/json" style="display: none" />
          <button id="clearBtn" title="Delete all points">Clear</button>
        </div>
        <div class="small">
          Click the map to add a point. Edit in the popup. Data is saved to your browser (localStorage).
        </div>
      </div>
      <div class="list" id="list"></div>
      <div class="footer">Using <code>Nevos_main.png</code> (1024×1024). Update <code>IMAGE_W</code>/<code>IMAGE_H</code> if you change the map.</div>
    </aside>
    <div id="map"></div>
  </div>
  <!-- Leaflet JS (online version; swap for local copy if running offline) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- D3 for grid rendering -->
  <script src="https://d3js.org/d3-selection.v3.min.js"></script>
  <script>
    // ======= CONFIG =======
    // Path to your map image; it's in the same folder as this HTML file
    const IMAGE_URL = 'Nevos_main.png';
    // Image dimensions (px)
    const IMAGE_W = 1024;
    const IMAGE_H = 1024;
    // Grid settings: adjust GRID_ROWS and GRID_COLS to change the number of letters/numbers
    const GRID_ROWS = 10; // A..J
    const GRID_COLS = 10; // 1..10
    const GRID_COLOR = 'rgba(0,0,0,0.25)';
    const STORAGE_KEY = 'nevos-grid-map:v1';
    // ======= MAP INITIALISATION =======
    const bounds = [[0, 0], [IMAGE_H, IMAGE_W]]; // [y,x] for CRS.Simple
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomSnap: 0.25,
      zoomDelta: 0.5,
      preferCanvas: true,
    });
    const image = L.imageOverlay(IMAGE_URL, bounds).addTo(map);
    map.fitBounds(bounds);
    // Create a pane for grid lines that scales with the map
    const gridPane = map.createPane('gridPane');
    gridPane.style.pointerEvents = 'none';
    const gridSvg = L.svg({ pane: 'gridPane' }).addTo(map);
    // ======= GRID RENDERING =======
    function drawGrid() {
      const svg = d3select(gridSvg._container).select('svg');
      svg.selectAll('*').remove();
      const g = svg.append('g').attr('class', 'grid');
      const cellW = IMAGE_W / GRID_COLS;
      const cellH = IMAGE_H / GRID_ROWS;
      // Draw vertical lines
      for (let c = 0; c <= GRID_COLS; c++) {
        const x = c * cellW;
        const p1 = map.latLngToLayerPoint([0, x]);
        const p2 = map.latLngToLayerPoint([IMAGE_H, x]);
        g.append('line')
          .attr('class', 'grid-line')
          .attr('x1', p1.x)
          .attr('y1', p1.y)
          .attr('x2', p2.x)
          .attr('y2', p2.y)
          .attr('stroke', GRID_COLOR);
      }
      // Draw horizontal lines
      for (let r = 0; r <= GRID_ROWS; r++) {
        const y = r * cellH;
        const p1 = map.latLngToLayerPoint([y, 0]);
        const p2 = map.latLngToLayerPoint([y, IMAGE_W]);
        g.append('line')
          .attr('class', 'grid-line')
          .attr('x1', p1.x)
          .attr('y1', p1.y)
          .attr('x2', p2.x)
          .attr('y2', p2.y)
          .attr('stroke', GRID_COLOR);
      }
      // Labels along the top (columns) and left (rows)
      const labelContainer = ensureLabelContainer();
      labelContainer.innerHTML = '';
      // Column labels: numbers
      for (let c = 0; c < GRID_COLS; c++) {
        const xMid = (c + 0.5) * cellW;
        const p = map.latLngToLayerPoint([0, xMid]);
        addLabel(labelContainer, p.x, p.y + 6, String(c + 1));
      }
      // Row labels: letters
      for (let r = 0; r < GRID_ROWS; r++) {
        const yMid = (r + 0.5) * cellH;
        const p = map.latLngToLayerPoint([yMid, 0]);
        addLabel(labelContainer, p.x + 6, p.y, String.fromCharCode(65 + r));
      }
    }
    function ensureLabelContainer() {
      let el = gridPane.querySelector('.grid-labels');
      if (!el) {
        el = document.createElement('div');
        el.className = 'grid-labels';
        el.style.position = 'absolute';
        el.style.left = 0;
        el.style.top = 0;
        el.style.width = '100%';
        el.style.height = '100%';
        el.style.pointerEvents = 'none';
        gridPane.appendChild(el);
      }
      return el;
    }
    function addLabel(container, x, y, text) {
      const div = document.createElement('div');
      div.className = 'grid-label';
      div.style.transform = `translate(${x}px, ${y}px)`;
      div.textContent = text;
      container.appendChild(div);
    }
    function gridRefFromLatLng(latlng) {
      const cellW = IMAGE_W / GRID_COLS;
      const cellH = IMAGE_H / GRID_ROWS;
      const col = Math.min(GRID_COLS - 1, Math.max(0, Math.floor(latlng.lng / cellW)));
      const row = Math.min(GRID_ROWS - 1, Math.max(0, Math.floor(latlng.lat / cellH)));
      const rowLetter = String.fromCharCode(65 + row);
      return `${rowLetter}-${col + 1}`;
    }
    // Toggle grid visibility
    document.getElementById('showGrid').addEventListener('change', (e) => {
      gridPane.style.display = e.target.checked ? '' : 'none';
    });
    map.on('zoomend moveend', drawGrid);
    // ======= MARKERS & DATA =======
    // Load saved points from localStorage
    function loadPoints() {
      try {
        const json = localStorage.getItem(STORAGE_KEY);
        return json ? JSON.parse(json) : [];
      } catch (e) {
        console.error(e);
        return [];
      }
    }
    function savePoints(points) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    }
    let points = loadPoints();
    const markers = new Map();
    // Add existing points to the map
    points.forEach((pt) => {
      const m = createMarker(pt);
      markers.set(pt.id, m);
    });
    function createMarker(pt) {
      const marker = L.marker([pt.y, pt.x]).addTo(map);
      marker.on('click', () => openForm(marker, pt));
      return marker;
    }
    // Helper to open a form for editing/adding a point
    function openForm(marker, pt = null) {
      const isNew = !pt;
      if (isNew) {
        const latlng = marker.getLatLng();
        pt = {
          id: Date.now(),
          x: latlng.lng,
          y: latlng.lat,
          name: '',
          notes: '',
          tag: '',
          rating: 0,
          fav: false,
        };
      }
      const div = document.createElement('div');
      div.className = 'popup';
      const form = document.createElement('form');
      form.className = 'form-grid';
      form.innerHTML = `
        <label>Name<input type="text" name="name" value="${pt.name || ''}" /></label>
        <label>Notes<textarea name="notes">${pt.notes || ''}</textarea></label>
        <label>Tag<input type="text" name="tag" value="${pt.tag || ''}" /></label>
        <label>Rating<select name="rating">
          <option value="0" ${pt.rating == 0 ? 'selected' : ''}>0</option>
          <option value="1" ${pt.rating == 1 ? 'selected' : ''}>1</option>
          <option value="2" ${pt.rating == 2 ? 'selected' : ''}>2</option>
          <option value="3" ${pt.rating == 3 ? 'selected' : ''}>3</option>
          <option value="4" ${pt.rating == 4 ? 'selected' : ''}>4</option>
          <option value="5" ${pt.rating == 5 ? 'selected' : ''}>5</option>
        </select></label>
        <label><input type="checkbox" name="fav" ${pt.fav ? 'checked' : ''} /> Favorite</label>
        <div class="row">
          <button type="submit">Save</button>
          <button type="button" id="deleteBtn">Delete</button>
        </div>
      `;
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = new FormData(form);
        pt.name = data.get('name');
        pt.notes = data.get('notes');
        pt.tag = data.get('tag');
        pt.rating = parseInt(data.get('rating'), 10);
        pt.fav = data.get('fav') === 'on';
        // If it's a new point, assign location
        if (isNew) {
          const ll = marker.getLatLng();
          pt.x = ll.lng;
          pt.y = ll.lat;
          points.push(pt);
          markers.set(pt.id, marker);
        }
        savePoints(points);
        renderList();
        marker.closePopup();
      });
      form.querySelector('#deleteBtn').addEventListener('click', () => {
        marker.remove();
        points = points.filter((p) => p.id !== pt.id);
        markers.delete(pt.id);
        savePoints(points);
        renderList();
        marker.closePopup();
      });
      div.appendChild(form);
      marker.bindPopup(div).openPopup();
    }
    // Map click: add a new temporary marker
    map.on('click', (e) => {
      const marker = L.marker(e.latlng).addTo(map);
      openForm(marker, null);
    });
    // ======= LIST & SEARCH =======
    function renderList() {
      const listEl = document.getElementById('list');
      const onlyFavs = document.getElementById('onlyFavs').checked;
      const search = document.getElementById('search').value.trim().toLowerCase();
      listEl.innerHTML = '';
      points
        .filter((p) => {
          if (onlyFavs && !p.fav) return false;
          const cell = gridRefFromLatLng({ lat: p.y, lng: p.x });
          return (
            p.name.toLowerCase().includes(search) ||
            p.notes.toLowerCase().includes(search) ||
            p.tag.toLowerCase().includes(search) ||
            cell.toLowerCase().includes(search)
          );
        })
        .forEach((p) => {
          const cell = gridRefFromLatLng({ lat: p.y, lng: p.x });
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <h3>${p.name || '(Unnamed)'}</h3>
            <div class="meta">
              <span class="badge">${cell}</span>
              <span>${p.rating}★</span>
              <span>${p.tag}</span>
            </div>
            <div class="actions">
              <button class="btn edit">Edit</button>
              <button class="btn center">Center</button>
            </div>
          `;
          card.querySelector('.edit').addEventListener('click', () => {
            const marker = markers.get(p.id);
            openForm(marker, p);
          });
          card.querySelector('.center').addEventListener('click', () => {
            map.setView([p.y, p.x], map.getZoom());
          });
          listEl.appendChild(card);
        });
    }
    document.getElementById('search').addEventListener('input', renderList);
    document.getElementById('onlyFavs').addEventListener('change', renderList);
    // Export points as JSON
    document.getElementById('exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(points, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'nevos-map-points.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    // Import points from JSON
    document.getElementById('importFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const data = JSON.parse(evt.target.result);
          if (Array.isArray(data)) {
            points = data;
            // Remove existing markers
            markers.forEach((m) => m.remove());
            markers.clear();
            // Add new markers
            points.forEach((pt) => {
              const m = createMarker(pt);
              markers.set(pt.id, m);
            });
            savePoints(points);
            renderList();
          }
        } catch (err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
    });
    // Clear all points
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (!confirm('Delete all points?')) return;
      points = [];
      markers.forEach((m) => m.remove());
      markers.clear();
      savePoints(points);
      renderList();
    });
    // Initial render
    drawGrid();
    renderList();
  </script>
</body>
</html>