<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Crimson Horn ‚Äî Overhead Storefront</title>
  <style>
    :root{
      --bg:#0f1014; --panel:#171922; --muted:#99a1b3; --text:#e7eaf1; --accent:#c06bff; --accent2:#57e389; --warn:#ffb86b; --danger:#ff6b6b;
      --tile:#1c2030; --tile-hover:#272c41; --grid:#0c0e13; --badge:#2a2f45; --good:#7be07b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0d12,#121420);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    a{color:var(--accent)}
    header{position:sticky;top:0;z-index:10;background:rgba(12,14,19,.9);backdrop-filter:blur(6px);border-bottom:1px solid #1e2233}
    header .wrap{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 16px}
    .logo{font-weight:800;letter-spacing:.3px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{width:36ch;max-width:70vw;background:#0f1320;border:1px solid #232b40;color:var(--text);padding:8px 10px;border-radius:8px}
    .search button{background:var(--tile);border:1px solid #2c3550;color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}

    main{display:grid;grid-template-columns: 2fr 1fr;gap:14px;padding:16px;min-height:calc(100% - 56px)}
    .floor{
      background:radial-gradient(1200px 600px at 50% 0%,#13172a,#0e1120 60%,#0b0d17);
      padding:14px;border:1px solid #1c2033;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.35);
      display:grid;grid-template-rows:auto 1fr;gap:10px;
    }
    h2{margin:8px 4px 6px;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:.4px;text-transform:uppercase}

    .grid{
      display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(4,120px);gap:10px;background:linear-gradient(0deg,transparent,transparent),
      linear-gradient(90deg,var(--grid) 1px,transparent 1px),linear-gradient(0deg,var(--grid) 1px,transparent 1px);
      background-size:100% 100%, calc((100% - 20px)/3) 100%, 100% calc((100% - 30px)/4);
      background-position:0 0, 10px 0, 0 10px;
    }
    .tile{
      background:linear-gradient(180deg,var(--tile),#151a29);border:1px solid #242a3f;border-radius:12px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:.15s transform,.15s background;
    }
    .tile:hover{transform:translateY(-2px);background:var(--tile-hover)}
    .tile .name{font-weight:700;text-align:center;padding:8px 10px}
    .tile .sub{position:absolute;bottom:6px;left:10px;font-size:12px;color:var(--muted)}
    .tile .spot{position:absolute;top:6px;right:10px;font-size:11px;color:#9db}

    /* Drawer */
    .drawer{position:fixed;inset:auto 0 0 0;max-height:64%;background:rgba(10,12,18,.98);border-top:1px solid #232840;backdrop-filter:blur(6px);transform:translateY(110%);transition:transform .18s ease-out;z-index:30}
    .drawer.open{transform:translateY(0)}
    .drawer .inner{display:grid;grid-template-columns: 1fr 1fr;gap:14px;padding:14px}
    .drawer h3{margin:2px 0 6px}
    .vendor-head{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .vendor-meta{font-size:13px;color:var(--muted)}
    .close{background:var(--tile);border:1px solid #2d3450;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}

    .items{border:1px solid #222a42;border-radius:12px;overflow:hidden}
    .items header{display:flex;gap:8px;align-items:center;justify-content:space-between;background:#121528;border-bottom:1px solid #20253a;padding:10px}
    .items input{background:#0f1320;border:1px solid #232b40;color:var(--text);padding:6px 8px;border-radius:8px;width:260px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #20253a;vertical-align:top}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.2px}
    td .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
    .tag{background:var(--badge);border:1px solid #3a405d;border-radius:999px;padding:2px 8px;font-size:12px;color:#c9d1ff}
    .curse{color:var(--warn);font-weight:700}
    .btn{background:#20263d;border:1px solid #2c3550;color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer}

    /* Cart */
    .cart{background:var(--panel);border:1px solid #232a41;border-radius:14px;padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px}
    .cart h3{margin:4px 2px}
    .cart-list{overflow:auto;max-height:50vh;border-top:1px dashed #2a3048;border-bottom:1px dashed #2a3048}
    .cart-line{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:8px 0;border-bottom:1px solid #1b2034}
    .cart-total{display:flex;justify-content:space-between;align-items:center}

    footer{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px;color:var(--muted)}
    .lock{cursor:pointer;padding:4px 8px;border-radius:6px;border:1px solid #2a3048;background:#13182a;color:var(--muted)}
    .lock.on{color:#fbd}

    /* Small screens */
    @media (max-width: 1000px){
      main{grid-template-columns: 1fr}
      .drawer .inner{grid-template-columns:1fr}
      .items input{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="logo">üèüÔ∏è The Crimson Horn ‚Äî Grand Indoor Market</div>
      <div class="search">
        <input id="globalSearch" placeholder="Search stalls & items‚Ä¶ (e.g., 'harvest', 'tools', '^')" />
        <button id="clearSearch" title="Clear">Clear</button>
      </div>
    </div>
  </header>

  <main>
    <section class="floor">
      <h2>Overhead Floor ‚Äî tap a stall</h2>
      <div class="grid" id="floorGrid"></div>
    </section>

    <aside class="cart" aria-label="Cart & Receipt">
      <h3>üßæ Receipt</h3>
      <div class="cart-list" id="cartList"></div>
      <div class="cart-total">
        <div id="cartTotal">0 gp</div>
        <div style="display:flex;gap:6px">
          <button class="btn" id="copyReceipt">Copy</button>
          <button class="btn" id="printReceipt">Print</button>
          <button class="btn" id="clearCart">Clear</button>
        </div>
      </div>
      <footer>
        <div>Prices in gp unless noted. <span id="dmBadge" style="display:none">DM Mode</span></div>
        <button class="lock" id="dmToggle" title="Toggle DM Mode">üîí DM</button>
      </footer>
    </aside>
  </main>

  <!-- Drawer for vendor inventory -->
  <div id="drawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="inner">
      <div>
        <div class="vendor-head">
          <div>
            <h3 id="vendorName">Vendor</h3>
            <div class="vendor-meta" id="vendorMeta"></div>
          </div>
          <button class="close" id="closeDrawer">Close</button>
        </div>

        <div class="items">
          <header>
            <div><strong>Items</strong></div>
            <input id="itemFilter" placeholder="Filter this stall‚Ä¶" />
          </header>
          <div style="overflow:auto;max-height:45vh">
            <table id="itemTable">
              <thead>
                <tr>
                  <th style="width:35%">Item</th>
                  <th style="width:10%">Price</th>
                  <th style="width:10%">Weight</th>
                  <th style="width:30%">Notes</th>
                  <th style="width:15%">Add</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="dmPane" style="display:none">
        <h3>DM Notes for this Stall</h3>
        <div id="dmNotes" style="border:1px solid #2a3048;border-radius:12px;padding:10px"></div>
        <h3 style="margin-top:14px">Global Cursed / Unidentified Index</h3>
        <div id="globalCurses" style="border:1px solid #2a3048;border-radius:12px;padding:10px;max-height:32vh;overflow:auto"></div>
      </div>
    </div>
  </div>

<script>
// ------------------ Data ------------------
const DATA = {
  stalls: [
    {
      id: 'rogan',
      spot: 'NW Corner',
      name: 'Rogan ‚ÄúRedhorn‚Äù Vesk',
      race: 'Orc',
      role: 'Owner / Pit‚ÄëMarshal',
      quick: 'Retired duel champion; missing left tusk; keeps a ledger of unpaid dueling debts.',
      items: [
        { name: 'Duelist‚Äôs Chalk & Circle Stencil', price_gp: 8, weight: '2 lb', notes: 'Reusable stencil for regulation rings; powdered chalk.' },
        { name: '^ Grudge‚ÄëLedger Slate', price_gp: 35, weight: '1 lb', notes: 'Records the buyer‚Äôs ‚Äúowed victories‚Äù. Hard to discard.', curseId: 'grudge-ledger' },
        { name: 'Pit Token (set of 5)', price_gp: 5, weight: '‚Äî', notes: 'Grants entry to side‚Äëring practice bouts.' },
        { name: 'Marshal‚Äôs Whistle', price_gp: 1, weight: '‚Äî', notes: 'Piercing tone; advantage to startle beasts (once per day).'},
      ],
      dm: [
        { id: 'grudge-ledger', title: 'Grudge‚ÄëLedger Slate', detect: 'DC 14 Arcana/Religion spots faint ink bleed at Torch‚Äëset.', effect: 'Attunes on first signature. Until a duel is ‚Äúwon‚Äù, buyer rolls one attack per long rest with ‚àí1 (manifested doubt). Breaking the slate deals 2d6 psychic to holder.', remedy: 'Win a formal duel or wash the slate in moon‚Äësalt while a rightful victor signs over the mark.' }
      ]
    },
    {
      id: 'mira',
      spot: 'N Edge',
      name: 'Mira Stoneham',
      race: 'Human',
      role: 'Quartermaster / Black‚ÄëRack Merchandise',
      quick: 'Former siege‚Äësmith; sells spare gear & patch‚Äëplates.',
      items: [
        // Tools (2014/conv prices as placeholders; adjust if using 2024 book)
        { name: 'Artisan‚Äôs Tools ‚Äî Smith‚Äôs', price_gp: 20, weight: '8 lb', notes: 'Tools & Games pricing may vary by 2024 rules.' },
        { name: 'Artisan‚Äôs Tools ‚Äî Leatherworker‚Äôs', price_gp: 5, weight: '5 lb', notes: '' },
        { name: 'Artisan‚Äôs Tools ‚Äî Carpenter‚Äôs', price_gp: 8, weight: '6 lb', notes: '' },
        { name: 'Artisan‚Äôs Tools ‚Äî Tinker‚Äôs', price_gp: 50, weight: '10 lb', notes: '' },
        { name: 'Artisan‚Äôs Tools ‚Äî Alchemist‚Äôs Supplies', price_gp: 50, weight: '8 lb', notes: '' },
        { name: 'Artisan‚Äôs Tools ‚Äî Brewer‚Äôs Supplies', price_gp: 20, weight: '6 lb', notes: '' },
        { name: 'Gaming Set ‚Äî Dice', price_gp: 1, weight: '‚Äî', notes: '' },
        { name: 'Gaming Set ‚Äî Cards', price_gp: 5, weight: '‚Äî', notes: '' },
        { name: 'Gaming Set ‚Äî Three‚ÄëDragon Ante (deck)', price_gp: 10, weight: '‚Äî', notes: '' },
        { name: 'Musical Instrument ‚Äî Drum', price_gp: 6, weight: '3 lb', notes: '' },
        { name: 'Patch‚ÄëPlate (armor repair)', price_gp: 7, weight: '2 lb', notes: 'Temporary +1 AC vs. one hit; 24h adhesive.' },
        { name: '^ Violet Vault Patch', price_gp: 25, weight: '‚Äî', notes: 'Adheres to anything; sometimes to skin by ‚Äúchoice‚Äù.', curseId: 'violet-vault' },
      ],
      dm: [
        { id: 'violet-vault', title: 'Violet Vault Patch', detect: 'DC 13 Arcana notices planar resin swirl.', effect: 'If applied to flesh, sticks until next new‚ÄëTorch; removing early deals 1d6 acid and leaves a sigil scar.', remedy: 'Dissolve with swamp‚Äëmint oil and salt under mountain water.' }
      ]
    },
    {
      id: 'axellip',
      spot: 'NE Corner',
      name: 'Axellip Maze',
      race: 'Halfling',
      role: 'Valerost Constellation / Zodiac Items',
      quick: 'Star‚Äëcartomancer; sells moon‚Äëtimed charms; tracks who buys which sign.',
      items: [
        { name: 'Zodiac Charm ‚Äî Wanderer‚Äôs Heart', price_gp: 18, weight: '‚Äî', notes: 'Once per night, +1 to a navigation check under clear moons.' },
        { name: 'Chart, Valerost Nightroads', price_gp: 12, weight: '1 lb', notes: 'Advantage to avoid getting lost in Valerost after dusk.' },
        { name: '^ Hollow Trace Sigil Pin', price_gp: 30, weight: '‚Äî', notes: 'Looks like protection; isn‚Äôt. Draws mild attention from the wrong eyes.', curseId: 'hollow-trace' },
      ],
      dm: [
        { id: 'hollow-trace', title: 'Hollow Trace Sigil Pin', detect: 'DC 15 Religion identifies counterfeit blessing.', effect: 'While worn, first Stealth check each day made with disadvantage as something unseen ‚Äúnotices.‚Äù', remedy: 'Place in sunrise bowl with fresh ink; speak true name of buyer to sever notice.' }
      ]
    },

    {
      id: 'pins',
      spot: 'W Edge',
      name: 'Nera ‚ÄúPins‚Äù Volesh',
      race: 'Gnome',
      role: 'Always‚ÄëOn Trinkets',
      quick: 'Self‚Äëpowered charms; 3‚Äëday swap policy.',
      items: [
        { name: 'Stitchlight Button', price_gp: 9, weight: '‚Äî', notes: 'Gives dim light when pricked; lasts 8 hours/day.' },
        { name: 'Sentry Pepper', price_gp: 4, weight: '‚Äî', notes: 'Explodes into sneeze cloud on intrusion (DC 12 Con).'},
        { name: '^ Tick‚ÄëTock Locket', price_gp: 25, weight: '‚Äî', notes: 'Whispers timely advice‚Ä¶ too timely.', curseId: 'tock-locket' },
      ],
      dm: [
        { id: 'tock-locket', title: 'Tick‚ÄëTock Locket', detect: 'DC 12 Arcana hears a second hand with no gears.', effect: 'Each dawn wearer must choose: +1 to Initiative OR ‚àí1 to first saving throw (fate tug).', remedy: 'Bury under a crossroads until both moons wane.'}
      ]
    },

    {
      id: 'boran',
      spot: 'Center',
      name: 'Boran Pike',
      race: 'Half‚ÄëOrc',
      role: 'Common Stock ‚Äî Martial Traveller Gear',
      quick: 'Ex‚Äëroad scout; kit is clean, oiled, field‚Äëtested.',
      items: [
        { name: 'Bedroll', price_gp: 1, weight: '7 lb', notes: '' },
        { name: 'Climber‚Äôs Kit', price_gp: 25, weight: '12 lb', notes: '' },
        { name: 'Healer‚Äôs Kit (10 uses)', price_gp: 5, weight: '3 lb', notes: '' },
        // Monster‚Äëharvesting kit (‚âà25 gp each)
        { name: 'Bone Saw (folding)', price_gp: 25, weight: '2 lb', notes: 'For skeletal extractions; etched ruler.' },
        { name: 'Gland Extractor & Ampoules', price_gp: 25, weight: '2 lb', notes: 'Pull volatile sacs intact; 6 vacuum vials.' },
        { name: 'Preservative Jars (warded set)', price_gp: 25, weight: '6 lb', notes: 'Three‚Äëseal jars; suspends decay for 7 days.' },
        { name: 'Field Alchemy Roll', price_gp: 25, weight: '4 lb', notes: 'Mini mortar, filters, spirit lamp.' },
        { name: 'Solvent Wash & Silvering Rinse', price_gp: 25, weight: '3 lb', notes: 'Neutralizes ichors; safe on gear.' },
        { name: 'Rune Tags (engraving kit)', price_gp: 25, weight: '2 lb', notes: 'Mark parts with origin, moon, site; later fetch +10%.' },
        { name: 'Cold‚ÄëPack Satchel', price_gp: 25, weight: '5 lb', notes: 'Alchemical chill for 8 hours; refreeze nightly.' },
        { name: 'Warded Specimen Case', price_gp: 35, weight: '10 lb', notes: 'Lockable chest; faint abjuration.' },
      ],
      dm: []
    },

    {
      id: 'tassia',
      spot: 'E Edge',
      name: 'Tassia Wick',
      race: 'Tiefling',
      role: 'Single‚ÄëUse Battle Curios',
      quick: 'One‚Äëand‚Äëdone talismans‚Äîsnap, throw, shatter; burn‚Äëscarred, unfazed.',
      items: [
        { name: 'Shiver Bead', price_gp: 15, weight: '‚Äî', notes: 'Cold pop; 10‚Äëft cube difficult terrain for 1 round.' },
        { name: 'Smokeglass Vial', price_gp: 12, weight: '‚Äî', notes: 'Light‚Äëeating smoke; lightly obscured 20‚Äëft radius 1 min.' },
        { name: 'Shock‚ÄëFuse Clip', price_gp: 18, weight: '‚Äî', notes: 'Next weapon hit deals +1d4 lightning.' },
        { name: '^ Hollow Fang Whistle', price_gp: 28, weight: '‚Äî', notes: 'Summons ‚Äúhelpful echoes‚Äù; sometimes something else.', curseId: 'hollow-fang' },
      ],
      dm: [
        { id: 'hollow-fang', title: 'Hollow Fang Whistle', detect: 'DC 14 Arcana or Nature notices predatory harmonics.', effect: '1/day on use roll d6: on 1, a hostile lesser echo‚Äëbeast appears (MM wolf stats).', remedy: 'Soak in brine and hang where two roads cross for a night.' }
      ]
    },

    {
      id: 'yarrow',
      spot: 'SW Corner',
      name: 'Old Yarrow Flint',
      race: 'Dwarf',
      role: 'Weapon Oddities',
      quick: 'Collects misfit prototypes; insists on live demo behind the sand wall.',
      items: [
        { name: 'Counter‚Äëcurve Falx', price_gp: 32, weight: '3 lb', notes: 'On crit: choose to disarm instead of extra damage.' },
        { name: '^ Backbiter Knife', price_gp: 12, weight: '1 lb', notes: 'Fine balance; occasionally cuts its owner when sheathed.', curseId: 'backbiter' },
        { name: 'Spring‚Äëbow Gauntlet', price_gp: 40, weight: '4 lb', notes: 'Hand crossbow analog; loads with wrist snap.' },
      ],
      dm: [
        { id: 'backbiter', title: 'Backbiter Knife', detect: 'DC 12 Perception sees nicks on inner sheath.', effect: 'Whenever you sheathe after a miss, DC 10 Dex save or take 1 piercing.', remedy: 'Wrap in moss for a night; re‚Äëoil with boar fat.' }
      ]
    },

    {
      id: 'kait',
      spot: 'S Edge',
      name: 'Kait ‚Äúthe Binder‚Äù',
      race: 'Mapach (raccoon‚Äëfolk)',
      role: 'Ready‚ÄëMade Packs',
      quick: 'Pre‚Äëbundled Scout/Healer/Delve kits; deposit refunded if returned intact.',
      items: [
        { name: 'Scout Pack (bundle)', price_gp: 18, weight: '‚Äî', notes: 'Bedroll, mess kit, 10 torches, 50 ft rope, tinderbox.' },
        { name: 'Healer Pack (bundle)', price_gp: 25, weight: '‚Äî', notes: 'Healer‚Äôs kit (10), 2 bandage wraps, smelling salts.' },
        { name: 'Delver Pack (bundle)', price_gp: 24, weight: '‚Äî', notes: 'Piton set, hammer, chalk, hooded lantern, oil x4.' },
        { name: '^ Unmarked Locker Key', price_gp: 5, weight: '‚Äî', notes: 'Fits a locker ‚Äúsomewhere in town‚Äù.', curseId: 'locker-key' },
      ],
      dm: [
        { id: 'locker-key', title: 'Unmarked Locker Key', detect: 'DC 13 Investigation reveals salty tarnish.', effect: 'Opens a locker with a minor haunt; first opener hears whispers‚ÄîDisadvantage on first Wisdom check while inside docks.', remedy: 'Return key to any river‚Äëshrine and leave a copper.' }
      ]
    },

    {
      id: 'fenn',
      spot: 'SE Corner',
      name: 'Fenn ‚ÄúTwo‚ÄëCoppers‚Äù Sal',
      race: 'Human',
      role: 'Tavern Rumours',
      quick: 'Sells sealed rumor slips; discounts for proof; banned from dice tables.',
      items: [
        { name: 'Rumor Slip ‚Äî Ledger Bleeds Ink', price_gp: 0.2, weight: '‚Äî', notes: 'Free whisper; pay 0.2 gp (2 sp) for details.' },
        { name: 'Rumor Slip ‚Äî Singing Lights on the River', price_gp: 0.5, weight: '‚Äî', notes: '5 sp for wreckers‚Äô details.' },
        { name: 'Rumor Slip ‚Äî Door that Knows Markets', price_gp: 1, weight: '‚Äî', notes: '1 gp for phrase and sigil.' },
        { name: 'Rumor Slip ‚Äî Council False Face', price_gp: 2, weight: '‚Äî', notes: '2 gp names the Elder.' },
        { name: 'Rumor Slip ‚Äî Eye in the Dunes', price_gp: 1, weight: '‚Äî', notes: '1 gp buyer alias & route.' },
        { name: 'Rumor Slip ‚Äî Thirteenth Night Beacon', price_gp: 0.6, weight: '‚Äî', notes: '6 sp for rune/countermeasure.' },
        { name: 'Rumor Slip ‚Äî Lying Fish & Fear‚Äësalve', price_gp: 0.4, weight: '‚Äî', notes: '4 sp tide & buyer tips.' },
        { name: 'Rumor Slip ‚Äî Wanderer‚Äôs Heart Will Crown', price_gp: 1, weight: '‚Äî', notes: '1 gp chart & sigil order.' },
      ],
      dm: []
    },
    {
      id: 'general',
      spot: 'S Alley',
      name: 'General Goods (Guild Counter)',
      race: 'Various',
      role: 'All Equipment ‚Äî General Goods',
      quick: 'Catch-all counter for common goods. In DM mode, paste the ThievesGuild "All Equipment" table to bulk-load everything.',
      items: [
        { name: 'Abacus', price_gp: 2, weight: '2 lb', notes: 'Counting frame. (PHB baseline)' },
        { name: 'Backpack', price_gp: 2, weight: '5 lb', notes: 'Adventuring gear' },
        { name: 'Bedroll', price_gp: 1, weight: '7 lb', notes: '' },
        { name: 'Ball Bearings (1,000)', price_gp: 1, weight: '2 lb', notes: '' },
        { name: 'Rope, hempen (50 ft.)', price_gp: 1, weight: '10 lb', notes: '' },
        { name: 'Rope, silk (50 ft.)', price_gp: 10, weight: '5 lb', notes: '' },
        { name: 'Torch', price_gp: 0.01, weight: '1 lb', notes: '' },
        { name: 'Tinderbox', price_gp: 0.5, weight: '1 lb', notes: '' },
        { name: 'Rations (1 day)', price_gp: 0.5, weight: '2 lb', notes: '' },
        { name: 'Waterskin', price_gp: 0.2, weight: '5 lb (full)', notes: '' },
        { name: 'Crowbar', price_gp: 2, weight: '5 lb', notes: '' },
        { name: 'Hammer', price_gp: 1, weight: '3 lb', notes: '' },
        { name: 'Piton (10)', price_gp: 1, weight: '5 lb', notes: '' },
        { name: 'Healer‚Äôs Kit (10 uses)', price_gp: 5, weight: '3 lb', notes: '' },
        { name: 'Clothes, traveler‚Äôs', price_gp: 2, weight: '4 lb', notes: '' },
        { name: 'Lock', price_gp: 10, weight: '1 lb', notes: '' },
        { name: 'Lantern, hooded', price_gp: 5, weight: '2 lb', notes: '' },
        { name: 'Lantern, bullseye', price_gp: 10, weight: '2 lb', notes: '' },
        { name: 'Oil (flask)', price_gp: 0.1, weight: '1 lb', notes: '' },
        { name: 'Grappling Hook', price_gp: 2, weight: '4 lb', notes: '' },
        { name: 'Spyglass', price_gp: 1000, weight: '1 lb', notes: '' },
        { name: 'Merchant‚Äôs Scale', price_gp: 5, weight: '3 lb', notes: '' },
        { name: 'Ink (1 oz bottle)', price_gp: 10, weight: '‚Äî', notes: '' },
        { name: 'Paper (1 sheet)', price_gp: 0.2, weight: '‚Äî', notes: '' },
        { name: 'Parchment (1 sheet)', price_gp: 0.1, weight: '‚Äî', notes: '' },
        { name: 'Soap', price_gp: 0.02, weight: '‚Äî', notes: '' },
        { name: 'Vial (glass)', price_gp: 1, weight: '‚Äî', notes: '' },
        { name: 'Bottle, glass', price_gp: 2, weight: '2 lb', notes: '' },
        { name: 'Bucket', price_gp: 0.05, weight: '2 lb', notes: '' },
        { name: 'Barrel', price_gp: 2, weight: '70 lb', notes: '' },
        { name: 'Tent (2-person)', price_gp: 2, weight: '20 lb', notes: '' },
        { name: 'Shovel', price_gp: 2, weight: '5 lb', notes: '' },
        { name: 'Whetstone', price_gp: 0.01, weight: '1 lb', notes: '' },
        { name: 'Cook‚Äôs Utensils', price_gp: 1, weight: '8 lb', notes: 'Tool' },
        { name: 'Smith‚Äôs Tools', price_gp: 20, weight: '8 lb', notes: 'Tool' },
        { name: 'Tinker‚Äôs Tools', price_gp: 50, weight: '10 lb', notes: 'Tool' },
        { name: 'Cartographer‚Äôs Tools', price_gp: 15, weight: '6 lb', notes: 'Tool' },
        { name: 'Disguise Kit', price_gp: 25, weight: '3 lb', notes: 'Kit' },
        { name: 'Forgery Kit', price_gp: 15, weight: '5 lb', notes: 'Kit' },
        { name: 'Gaming Set ‚Äî Dice', price_gp: 0.1, weight: '‚Äî', notes: '' },
        { name: 'Gaming Set ‚Äî Cards', price_gp: 0.5, weight: '‚Äî', notes: '' },
        { name: 'Instrument ‚Äî Flute', price_gp: 2, weight: '1 lb', notes: '' },
        { name: 'Instrument ‚Äî Lute', price_gp: 35, weight: '2 lb', notes: '' },
        { name: 'Mount ‚Äî Mule', price_gp: 8, weight: '‚Äî', notes: '' },
        { name: 'Saddle, pack', price_gp: 5, weight: '15 lb', notes: '' },
        { name: 'Rations (1 week)', price_gp: 3.5, weight: '14 lb', notes: 'Convenience bundle' }
      ],
      dm: [
        { id: 'gg-import', title: 'ThievesGuild Equipment Importer', detect: 'DM utility', effect: 'In DM mode, paste the ‚ÄúAll Equipment‚Äù page content from thievesguild.cc and click Import. The parser will attempt to extract Item, Cost (Norm) and Weight; currency sp/cp are converted to gp.', remedy: 'If a row fails to parse, reformat as: name | cost unit | weight (e.g., "Abacus | 2 gp | 2 lb").' }
      ]
    }
  ]
};

// Build quick index of all curses for DM global list
const CURSE_INDEX = (()=>{
  const map = new Map();
  for(const s of DATA.stalls){
    for(const d of (s.dm||[])) map.set(d.id, {...d, stall:s.name});
  }
  return map;
})();

// -------------- Floor grid --------------
const gridEl = document.getElementById('floorGrid');
function renderFloor(filter=''){
  gridEl.innerHTML = '';
  const matches = (s)=> (s.name+" "+s.role+" "+s.quick).toLowerCase().includes(filter.toLowerCase());
  const list = DATA.stalls.filter(matches);
  const order = ['rogan','pins','yarrow','mira','boran','tassia','axellip','kait','fenn'];
  const byId = new Map(list.map(x=>[x.id,x]));
  // 3x3 template positions
  const layout = [ 'rogan','mira','axellip', 'pins','boran','tassia', 'yarrow','kait','fenn', 'general','spare1','spare2' ];
  for(const id of layout){
    const s = byId.get(id);
    const tile = document.createElement('div');
    tile.className = 'tile';
    if(s){
      tile.innerHTML = `<div class="name">${s.name}</div><div class="sub">${s.role}</div><div class="spot">${s.spot||''}</div>`;
      tile.addEventListener('click',()=>openStall(s.id));
      tile.title = s.quick || '';
    } else {
      tile.style.opacity = .25; tile.style.pointerEvents='none';
    }
    gridEl.appendChild(tile);
  }
}
renderFloor();

// Global search across stalls
const globalSearch = document.getElementById('globalSearch');
const clearSearch = document.getElementById('clearSearch');
globalSearch.addEventListener('input', ()=> renderFloor(globalSearch.value));
clearSearch.addEventListener('click', ()=>{globalSearch.value=''; renderFloor('');});

// -------------- Drawer & Stall Render --------------
const drawer = document.getElementById('drawer');
const vendorName = document.getElementById('vendorName');
const vendorMeta = document.getElementById('vendorMeta');
const itemFilter = document.getElementById('itemFilter');
const itemTableBody = document.querySelector('#itemTable tbody');
const dmPane = document.getElementById('dmPane');
const dmNotes = document.getElementById('dmNotes');
const globalCurses = document.getElementById('globalCurses');
const dmBadge = document.getElementById('dmBadge');
let CURRENT_STALL = null;
let DM_MODE = false;

function openStall(id){
  const s = DATA.stalls.find(x=>x.id===id);
  if(!s) return;
  CURRENT_STALL = s;
  vendorName.textContent = s.name;
  vendorMeta.textContent = `${s.race} ‚Äî ${s.role}. ${s.quick||''}`;
  itemFilter.value = '';
  renderItems();
  renderDMForStall();
  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden','false');
}
function closeStall(){
  drawer.classList.remove('open');
  drawer.setAttribute('aria-hidden','true');
}

document.getElementById('closeDrawer').addEventListener('click', closeStall);

function renderItems(){
  const s = CURRENT_STALL; if(!s) return;
  const q = itemFilter.value.trim().toLowerCase();
  itemTableBody.innerHTML = '';
  for(const it of s.items){
    const hay = `${it.name} ${it.notes}`.toLowerCase();
    if(q && !hay.includes(q)) continue;
    const tr = document.createElement('tr');
    const isCursed = !!it.curseId;
    const name = isCursed ? `<span class="curse">^</span> ${it.name.replace(/^\^\s*/,'')}` : it.name;
    const price = formatPrice(it.price_gp);
    const tags = [];
    if(isCursed) tags.push('cursed');
    const notes = DM_MODE && isCursed ? (CURSE_INDEX.get(it.curseId)?.effect || it.notes) : it.notes;
    tr.innerHTML = `
      <td>${name}<div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div></td>
      <td>${price}</td>
      <td>${it.weight||'‚Äî'}</td>
      <td>${escapeHtml(notes||'')}</td>
      <td><button class="btn">Add</button></td>`;
    tr.querySelector('button').addEventListener('click', ()=> addToCart(s, it));
    itemTableBody.appendChild(tr);
  }
}
itemFilter.addEventListener('input', renderItems);

function renderDMForStall(){
  dmPane.style.display = DM_MODE ? 'block' : 'none';
  dmBadge.style.display = DM_MODE ? 'inline' : 'none';
  if(!DM_MODE || !CURRENT_STALL) return;
  const list = CURRENT_STALL.dm || [];
  dmNotes.innerHTML = list.length ? list.map(d=>
    `<div style="margin:8px 0;padding:8px;border:1px dashed #3a4060;border-radius:8px">
      <strong>${d.title}</strong><br/>
      <em>Detect:</em> ${escapeHtml(d.detect)}<br/>
      <em>Effect:</em> ${escapeHtml(d.effect)}<br/>
      <em>Remedy:</em> ${escapeHtml(d.remedy)}
    </div>`
  ).join('') : '<em>No stall‚Äëspecific notes.</em>';

  // Global index once
  globalCurses.innerHTML = Array.from(CURSE_INDEX.values()).map(d=>
    `<div style="margin:8px 0;padding:8px;border:1px dashed #3a4060;border-radius:8px">
      <strong>${d.title}</strong> <span class="tag">${d.stall}</span><br/>
      <em>Detect:</em> ${escapeHtml(d.detect)}<br/>
      <em>Effect:</em> ${escapeHtml(d.effect)}<br/>
      <em>Remedy:</em> ${escapeHtml(d.remedy)}
    </div>`
  ).join('');
}

// -------------- Cart --------------
const cartList = document.getElementById('cartList');
const cartTotal = document.getElementById('cartTotal');
const copyReceipt = document.getElementById('copyReceipt');
const printReceipt = document.getElementById('printReceipt');
const clearCartBtn = document.getElementById('clearCart');
let CART = [];

function addToCart(stall, item){
  CART.push({stall: stall.name, item: item.name.replace(/^\^\s*/,'').trim(), gp: item.price_gp||0});
  renderCart();
}
function formatPrice(gp){
  // Keep it simple: decimals allowed for sp (0.1 = 1 sp)
  if(gp===undefined||gp===null) return '‚Äî';
  if(Math.abs(gp - Math.round(gp)) < 1e-6) return `${gp} gp`;
  // show sp if .1 steps
  const sp = Math.round((gp%1)*10);
  if(sp>0 && Math.abs(gp - Math.floor(gp) - sp/10) < 1e-6){
    return `${Math.floor(gp)} gp ${sp} sp`;
  }
  return `${gp.toFixed(2)} gp`;
}
function renderCart(){
  cartList.innerHTML = '';
  let total = 0;
  CART.forEach((c,idx)=>{
    total += (c.gp||0);
    const row = document.createElement('div');
    row.className = 'cart-line';
    row.innerHTML = `<div>${escapeHtml(c.item)} <span class="tag">${escapeHtml(c.stall)}</span></div>
                     <div>${formatPrice(c.gp)}</div>
                     <div><button class="btn" aria-label="Remove">‚úï</button></div>`;
    row.querySelector('button').addEventListener('click',()=>{CART.splice(idx,1);renderCart();});
    cartList.appendChild(row);
  });
  cartTotal.textContent = formatPrice(+total.toFixed(2));
}
copyReceipt.addEventListener('click', ()=>{
  const lines = CART.map(c=>`- ${c.item} (${c.stall}) ‚Äî ${formatPrice(c.gp)}`);
  lines.push(`\nTotal: ${cartTotal.textContent}`);
  navigator.clipboard.writeText(lines.join('\n')).then(()=>{
    copyReceipt.textContent='Copied'; setTimeout(()=>copyReceipt.textContent='Copy',1200);
  });
});
printReceipt.addEventListener('click', ()=> window.print());
clearCartBtn.addEventListener('click', ()=>{CART=[]; renderCart();});

// -------------- DM Mode Toggle --------------
const dmToggle = document.getElementById('dmToggle');
function setDM(on){ DM_MODE = !!on; dmToggle.classList.toggle('on', DM_MODE); dmToggle.textContent = DM_MODE ? 'üîì DM' : 'üîí DM'; renderItems(); renderDMForStall(); }
setDM(false);

dmToggle.addEventListener('click', ()=> setDM(!DM_MODE));
// Secret keyboard combo: D then M within 600ms
(function(){
  let lastD = 0; window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='d'){ lastD = Date.now(); }
    if(e.key.toLowerCase()==='m' && Date.now()-lastD < 600){ setDM(!DM_MODE); }
  });
})();

// Helpers
// General Goods importer augment (DM‚Äëonly)
(function(){
  const target = document.getElementById('dmPane');
  if(!target) return;
  const ensureUI = ()=>{
    if(!DM_MODE || !CURRENT_STALL || CURRENT_STALL.id!=='general') return;
    if(document.getElementById('ggImport')) return;
    const dmNotes = document.getElementById('dmNotes');
    if(!dmNotes) return;
    const html = `
      <div style=\"margin-top:12px;padding:10px;border:1px solid #394060;border-radius:10px;background:#101426\">
        <div style=\"display:flex;justify-content:space-between;align-items:center;gap:8px\">
          <strong>Bulk Import from ThievesGuild ‚ÄúAll Equipment‚Äù</strong>
          <button class=\"btn\" id=\"ggClear\">Clear Items</button>
        </div>
        <p style=\"color:#9aa3bd;margin:6px 0 8px\">Paste table content from <em>thievesguild.cc/equipment</em>. Parser extracts <em>Item</em>, <em>Cost (Norm)</em>, and <em>Weight</em>. Currency (sp/cp) is converted to gp.</p>
        <textarea id=\"ggPaste\" rows=\"8\" style=\"width:100%;background:#0f1320;color:#e7eaf1;border:1px solid #2b3350;border-radius:8px;padding:8px\" placeholder=\"Paste here‚Ä¶\"></textarea>
        <div style=\"display:flex;gap:8px;margin-top:8px\">
          <button class=\"btn\" id=\"ggImport\">Import</button>
          <button class=\"btn\" id=\"ggSample\">Load Sample</button>
          <div id=\"ggStatus\" style=\"color:#9bd\"></div>
        </div>
      </div>`;
    dmNotes.insertAdjacentHTML('beforeend', html);
    const paste = document.getElementById('ggPaste');
    document.getElementById('ggImport').onclick = ()=>{
      const txt = paste.value||''; const added = importThievesGuild(txt);
      document.getElementById('ggStatus').textContent = `Added ${added} items.`;
      renderItems();
    };
    document.getElementById('ggSample').onclick = ()=>{
      const sample = `Abacus\nCost: 2 gp\nWeight: 2 lb.\nBackpack\nCost: 2 gp\nWeight: 5 lb.`;
      paste.value = sample;
    };
    document.getElementById('ggClear').onclick = ()=>{ CURRENT_STALL.items = []; renderItems(); };
  };
  const obs = new MutationObserver(()=> ensureUI());
  obs.observe(target, { attributes:true, childList:true, subtree:true });
})();

function importThievesGuild(raw){
  if(!CURRENT_STALL) return 0;
  const lines = (raw||'').replace(/
/g,'').split(/
+/);
  const items = [];
  for(let i=0;i<lines.length;i++){
    const name = lines[i].trim();
    if(!name || /^(cost:|cheap:|expensive:|weight:|optional metal types|item|cost|weight)/i.test(name)) continue;
    let j=i+1, cost=null, unit='gp', weight='‚Äî';
    for(; j<Math.min(i+7, lines.length); j++){
      const L = lines[j].trim();
      const m = L.match(/^Cost:\s*([0-9,]+)\s*(gp|sp|cp)/i) || L.match(/^([0-9,]+)\s*(gp|sp|cp)$/i);
      if(m){ cost = parseFloat(m[1].replace(/,/g,'')); unit = m[2].toLowerCase(); }
      const w = L.match(/^Weight:\s*([^]+?)(?:\.|$)/i) || L.match(/^([0-9.]+\s*lb\.?.*)/i);
      if(w) weight = w[1].replace(/Wt|Weight:/i,'').trim();
    }
    if(cost!==null){
      const gp = unit==='gp'? cost : unit==='sp'? +(cost/10).toFixed(2) : +(cost/100).toFixed(2);
      items.push({ name, price_gp: gp, weight, notes: '' });
    }
  }
  const nameSet = new Set(CURRENT_STALL.items.map(x=>x.name));
  let added=0;
  for(const it of items){ if(!nameSet.has(it.name)){ CURRENT_STALL.items.push(it); nameSet.add(it.name); added++; } }
  return added;
}

// Helpers
function escapeHtml(s){ return (s||'').replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\\"":"&quot;","'":"&#39;"}[m])); }
</script>
</body>
</html>
